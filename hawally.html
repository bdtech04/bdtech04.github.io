<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Hawally Zone</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #10B981;
      --primary-dark: #059669;
      --accent: #F59E0B;
      --dark: #111827;
      --dark-light: #374151;
      --light: #F9FAFB;
      --white: #FFFFFF;
      --gray: #9CA3AF;
      --gray-light: #E5E7EB;
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.4);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --shadow-primary: 0 4px 20px rgba(16, 185, 129, 0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--light);
      color: var(--dark);
      min-height: 100vh;
      padding-bottom: 100px;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: ''; position: fixed; inset: 0; z-index: -1;
      background: 
        radial-gradient(circle at 10% 90%, rgba(16, 185, 129, 0.08), transparent 40%),
        radial-gradient(circle at 90% 10%, rgba(245, 158, 11, 0.08), transparent 40%);
      animation: bgMove 15s ease-in-out infinite alternate;
    }
    @keyframes bgMove { from { background-size: 100% 100%; } to { background-size: 120% 120%; } }

    header {
      position: sticky; top: 0; z-index: 100;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      padding: 12px 16px;
    }
    .search-wrapper { position: relative; width: 100%; }
    #searchInput {
      width: 100%; padding: 12px 40px 12px 16px;
      border-radius: 16px; 
      border: 1px solid #000000;
      background: var(--white); font-size: 15px;
      box-shadow: var(--shadow-sm); transition: all .3s;
    }
    #searchInput:focus { border-color: var(--primary); box-shadow: var(--shadow-primary); outline: none; }
    #clearSearch {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: var(--gray-light); border: none; color: var(--gray);
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      display: none; align-items: center; justify-content: center;
    }
    #clearSearch.visible { display: flex; }

    main { padding: 16px; max-width: 800px; margin: 0 auto; }
    
    #welcomeScreen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 60vh; text-align: center; animation: fadeIn .6s ease;
    }
    .icon-large { font-size: 48px; color: var(--primary); margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .loading-dots { display: flex; gap: 4px; margin-top: 10px; justify-content: center; }
    .dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: bounce 1.4s infinite; }
    .dot:nth-child(2) { animation-delay: .2s; } .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    #skeletonLoader { display: none; gap: 12px; }
    .skeleton {
      background: var(--gray-light); border-radius: 12px; padding: 16px;
      animation: pulse 1.5s infinite;
      border: 1px solid #e5e7eb;
    }
    .sk-line { height: 12px; margin-bottom: 8px; border-radius: 4px; background: #e2e8f0; }
    .sk-title { width: 60%; height: 18px; margin-bottom: 12px; margin-left: auto; margin-right: auto; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: .6; } 100% { opacity: 1; } }

    #locationList { display: none; grid-template-columns: 1fr; gap: 12px; }
    
    .card {
      background: var(--white); border-radius: 16px; padding: 16px;
      box-shadow: var(--shadow-sm); 
      border: 1px solid #000000;
      position: relative; overflow: visible; 
      transition: transform .2s;
      text-align: center;
    }
    .card.nearby { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); }
    
    .card-header { 
      display: flex; 
      justify-content: center; 
      position: relative; 
      margin-bottom: 12px; 
      width: 100%;
    }
    .card-title { 
      font-weight: 700; 
      font-size: 16px; 
      color: var(--dark); 
      width: 100%; 
      padding-right: 30px; 
      text-align: center; 
      margin: 0 auto; 
    }
    
    .fav-btn {
      position: absolute; top: 0; right: 0;
      background: none; border: none; color: var(--gray-light); font-size: 18px; cursor: pointer; transition: .2s;
      padding: 5px; 
      z-index: 2;
    }
    .fav-btn.active { color: var(--accent); transform: scale(1.1); }

    .card-body { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 8px; 
      position: relative; 
    }
    
    .badges { 
      display: flex; 
      justify-content: center; 
      gap: 8px; 
      flex-wrap: wrap; 
      width: 100%;
    }
    .badge {
      font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 600;
      display: flex; align-items: center; gap: 4px;
    }
    .badge-dist { background: rgba(16, 185, 129, 0.1); color: var(--primary-dark); }
    .badge-time { background: rgba(245, 158, 11, 0.1); color: #d97706; }

    .copy-btn {
      margin-top: 6px; 
      padding: 6px 24px; 
      background: var(--dark); 
      color: var(--white); 
      border: none;
      border-radius: 8px; 
      font-size: 11px; 
      font-weight: 500; 
      cursor: pointer;
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px;
      transition: background .2s, transform .1s;
      width: auto; 
      position: relative; 
      z-index: 1;
    }
    .copy-btn:active { transform: scale(0.95); }
    .copy-btn:hover { background: var(--primary); }

    .empty-state { text-align: center; padding: 40px; color: var(--gray); grid-column: 1/-1; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--glass-bg); backdrop-filter: blur(16px);
      border-top: 1px solid var(--glass-border);
      display: flex; justify-content: space-around; align-items: center;
      padding: 8px 12px max(8px, env(safe-area-inset-bottom));
      z-index: 100;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      color: var(--gray); font-size: 10px; font-weight: 600;
      background: none; border: none; cursor: pointer; width: 20%;
    }
    .nav-item i { font-size: 18px; margin-bottom: 4px; transition: .3s; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-3px); }

    .fab-container {
      position: relative; top: -24px;
      background: var(--white); width: 50px; height: 50px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow-md);
    }
    #addBtn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white); font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow-primary); transition: transform .2s;
    }
    #addBtn:active { transform: scale(0.9); }

    .nav-item.gps-active { color: var(--primary-dark); }
    .nav-item.gps-active i { animation: pulse-ring 2s infinite; }
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      z-index: 200; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity .3s;
    }
    .modal-overlay.open { display: flex; opacity: 1; }
    
    .modal {
      background: var(--white); width: 90%; max-width: 400px;
      border-radius: 20px; padding: 20px; box-shadow: var(--shadow-lg);
      transform: scale(0.9); transition: transform .3s;
    }
    .modal-overlay.open .modal { transform: scale(1); }
    
    .modal h3 { margin-bottom: 16px; font-size: 18px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; color: var(--dark-light); margin-bottom: 4px; }
    .form-group input {
      width: 100%; padding: 10px; border: 1px solid var(--gray-light);
      border-radius: 8px; font-family: inherit; outline: none;
    }
    .form-group input:focus { border-color: var(--primary); }
    
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .btn-cancel { background: var(--gray-light); color: var(--dark); }
    .btn-confirm { background: var(--primary); color: var(--white); }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-50px);
      background: var(--dark); color: var(--white); padding: 10px 20px;
      border-radius: 30px; font-size: 13px; font-weight: 500; z-index: 300;
      box-shadow: var(--shadow-lg); transition: transform .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex; align-items: center; gap: 8px; white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }
    #toast.success { background: var(--primary); }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Enhanced Winner Animation Styles */
    .confetti {
      position: fixed; 
      pointer-events: none;
      z-index: 9999;
      width: 10px;
      height: 10px;
      opacity: 0;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translate(0, 0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translate(var(--tx), var(--ty)) rotate(var(--rot));
        opacity: 0;
      }
    }

    @media (min-width: 600px) {
      #locationList { grid-template-columns: repeat(2, 1fr); }
      .bottom-nav { max-width: 500px; left: 50%; transform: translateX(-50%); border-radius: 20px 20px 0 0; }
    }
  </style>
</head>
<body>

  <div id="toast"><i class="fas fa-info-circle"></i> <span>Message</span></div>

  <header>
    <div class="search-wrapper">
      <input type="text" id="searchInput" placeholder="Search restaurants..." autocomplete="off">
      <button id="clearSearch"><i class="fas fa-times"></i></button>
    </div>
  </header>

  <main>
    <div id="welcomeScreen">
      <i class="fas fa-map-marked-alt icon-large"></i>
      <h2 style="font-weight: 700; margin-bottom: 8px;">Please wait</h2>
      <p style="color: var(--gray); font-size: 14px; margin-bottom: 20px;">Welcome to ardiya zone</p>
      <div class="loading-dots">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>

    <div id="skeletonLoader">
      <div class="skeleton"><div class="sk-line sk-title"></div><div class="sk-line" style="width: 40%; margin: 0 auto 8px;"></div></div>
      <div class="skeleton"><div class="sk-line sk-title"></div><div class="sk-line" style="width: 40%; margin: 0 auto 8px;"></div></div>
      <div class="skeleton"><div class="sk-line sk-title"></div><div class="sk-line" style="width: 40%; margin: 0 auto 8px;"></div></div>
    </div>

    <div id="locationList"></div>
  </main>

  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <h3>Add Restaurant</h3>
      <form id="addForm">
        <div class="form-group">
          <label>Restaurant name</label>
          <input type="text" id="newPlaceName" required placeholder="write restaurant name">
        </div>
        <div class="form-group">
          <label>Restaurant code </label>
          <input type="text" id="newPlaceCoords" required placeholder="Exam:29.000000, 47.000000">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" onclick="closeModal('addModal')">Cancel</button>
          <button type="submit" class="btn btn-confirm">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="locationModal">
    <div class="modal">
      <h3>Set Location</h3>
      <p style="font-size: 13px; color: var(--gray); margin-bottom: 12px;">
        GPS not access. Please enter coordinates manually.
      </p>
      <form id="manualLocForm">
        <div class="form-group">
          <label>Your location code </label>
          <input type="text" id="manualCoords" required placeholder="29.3117, 47.4818">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" onclick="closeModal('locationModal')">Cancel</button>
          <button type="submit" class="btn btn-confirm">Set Location</button>
        </div>
      </form>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" onclick="setFilter('all')" id="navHome">
      <i class="fas fa-home"></i> Home
    </button>
    <button class="nav-item" onclick="setFilter('fav')" id="navFav">
      <i class="fas fa-star"></i> Favorites
    </button>
    
    <div class="fab-container">
      <button id="addBtn" onclick="openModal('addModal')"><i class="fas fa-plus"></i></button>
    </div>
    
    <button class="nav-item" onclick="openMap()">
      <i class="fas fa-map"></i> Maps
    </button>
    <button class="nav-item" onclick="toggleGPS()" id="navGps">
      <i class="fas fa-crosshairs"></i> Gps
    </button>
  </nav>

  <script>
    const CONFIG = {
      API_URL: 'https://raw.githubusercontent.com/bdtech04/Mamu/refs/heads/main/zone.json',
      STORAGE_KEYS: {
        FAVS: 'ardiya_favs',
        USER_PLACES: 'ardiya_user_places',
        USER_LOC: 'ardiya_user_loc'
      }
    };

    const SAMPLE_DATA = [
      { name: "Sample Restaurant 1", coords: "29.3117, 47.4818" },
      { name: "Sample Restaurant 2", coords: "29.3345, 47.6578" },
      { name: "Sample Restaurant 3", coords: "29.7371, 47.9135" }
    ];

    let state = {
      allPlaces: [],
      userLocation: null,
      filter: 'all',
      search: ''
    };

    const UI = {
      welcome: document.getElementById('welcomeScreen'),
      skeleton: document.getElementById('skeletonLoader'),
      list: document.getElementById('locationList'),
      search: document.getElementById('searchInput'),
      clearSearch: document.getElementById('clearSearch'),
      toast: document.getElementById('toast'),
      navHome: document.getElementById('navHome'),
      navFav: document.getElementById('navFav'),
      navGps: document.getElementById('navGps') 
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadLocalData();
      initLocation();
      fetchRemoteData();

      UI.search.addEventListener('input', (e) => {
        state.search = e.target.value.toLowerCase();
        UI.clearSearch.style.display = state.search ? 'flex' : 'none';
        render();
      });
      UI.clearSearch.addEventListener('click', () => {
        UI.search.value = '';
        state.search = '';
        UI.clearSearch.style.display = 'none';
        render();
      });
      document.getElementById('addForm').addEventListener('submit', handleAddPlace);
      document.getElementById('manualLocForm').addEventListener('submit', handleManualLoc);
    });

    async function fetchRemoteData() {
      try {
        UI.welcome.style.display = 'none';
        UI.skeleton.style.display = 'grid';
        
        const res = await fetch(`${CONFIG.API_URL}?t=${Date.now()}`);
        if (!res.ok) throw new Error('Network response was not ok');
        
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          state.allPlaces = data.filter(p => p.name && p.coords);
        } else {
          throw new Error('Empty or invalid data');
        }
      } catch (err) {
        console.error('Fetch failed, using cache or sample data:', err);
        
        let localData = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.USER_PLACES) || '[]');
        
        if (localData.length > 0) {
          state.allPlaces = localData;
        } else {
          state.allPlaces = SAMPLE_DATA;
          showToast('Using sample data (Network/URL error)', 'info');
        }
      } finally {
        UI.skeleton.style.display = 'none';
        UI.list.style.display = 'grid';
        render();
      }
    }

    function loadLocalData() {
      const favs = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.FAVS) || '[]');
      state.favs = new Set(favs);
      
      const userPlaces = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.USER_PLACES) || '[]');
      state.userPlaces = userPlaces;
      
      const cachedLoc = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.USER_LOC));
      if (cachedLoc && (Date.now() - cachedLoc.ts < 24 * 60 * 60 * 1000)) {
        state.userLocation = cachedLoc;
        updateGPSIcon(true);
      }
    }

    function initLocation() {
      if (!navigator.geolocation) return;
      navigator.permissions.query({ name: 'geolocation' }).then(result => {
        if (result.state === 'granted') startGPSWatch();
      }).catch(() => {});
    }

    function toggleGPS() {
      if (state.userLocation) {
        showToast('Location is active', 'success');
        return;
      }
      
      UI.navGps.querySelector('i').className = 'fas fa-circle-notch fa-spin';
      
      navigator.geolocation.getCurrentPosition(
        (pos) => onLocationSuccess(pos.coords.latitude, pos.coords.longitude),
        (err) => {
          UI.navGps.querySelector('i').className = 'fas fa-crosshairs';
          console.warn(err);
          openModal('locationModal');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function startGPSWatch() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => onLocationSuccess(pos.coords.latitude, pos.coords.longitude),
          null,
          { enableHighAccuracy: false, timeout: 15000, maximumAge: 60000 }
        );
      }
    }

    function onLocationSuccess(lat, lng) {
      state.userLocation = { lat, lng, ts: Date.now() };
      localStorage.setItem(CONFIG.STORAGE_KEYS.USER_LOC, JSON.stringify(state.userLocation));
      updateGPSIcon(true);
      render();
    }

    function handleManualLoc(e) {
      e.preventDefault();
      const val = document.getElementById('manualCoords').value;
      const coords = parseCoords(val);
      if (coords) {
        onLocationSuccess(coords.lat, coords.lng);
        closeModal('locationModal');
        showToast('Location updated manually', 'success');
      } else {
        showToast('Invalid coordinates', 'error');
      }
    }

    function updateGPSIcon(active) {
      if (active) {
        UI.navGps.classList.add('gps-active');
        UI.navGps.querySelector('i').className = 'fas fa-crosshairs';
      } else {
        UI.navGps.classList.remove('gps-active');
      }
    }

    function parseCoords(str) {
      if (!str) return null;
      const parts = str.split(/[ ,]+/).map(Number).filter(n => !isNaN(n));
      if (parts.length >= 2) return { lat: parts[0], lng: parts[1] };
      return null;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; 
      const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function render() {
      UI.list.innerHTML = '';
      
      const combinedPlaces = [...state.allPlaces, ...state.userPlaces];
      
      let filtered = combinedPlaces.filter(p => {
        const matchesSearch = p.name.toLowerCase().includes(state.search);
        const matchesFav = state.filter === 'fav' ? state.favs.has(p.name) : true;
        return matchesSearch && matchesFav;
      });

      if (state.userLocation) {
        filtered.sort((a, b) => {
          const cA = parseCoords(a.coords);
          const cB = parseCoords(b.coords);
          if (!cA) return 1; if (!cB) return -1;
          const dA = getDistance(state.userLocation.lat, state.userLocation.lng, cA.lat, cA.lng);
          const dB = getDistance(state.userLocation.lat, state.userLocation.lng, cB.lat, cB.lng);
          return dA - dB;
        });
      } else {
        filtered.sort((a, b) => a.name.localeCompare(b.name));
      }

      if (filtered.length === 0) {
        UI.list.innerHTML = `<div class="empty-state"><i class="fas fa-search" style="font-size:24px; margin-bottom:8px;"></i><br>No places found</div>`;
        return;
      }

      filtered.slice(0, 50).forEach(place => {
        const coords = parseCoords(place.coords);
        const isFav = state.favs.has(place.name);
        
        let distHtml = '';
        let nearbyClass = '';
        
        if (state.userLocation && coords) {
          const distMeters = getDistance(state.userLocation.lat, state.userLocation.lng, coords.lat, coords.lng);
          const distKm = (distMeters / 1000).toFixed(1);
          const time = Math.ceil(distMeters / 1000 / 40 * 60);
          
          distHtml = `
            <div class="badges">
              <span class="badge badge-dist"><i class="fas fa-location-arrow"></i> ${distKm} km</span>
              <span class="badge badge-time"><i class="fas fa-car"></i> ${time} min</span>
            </div>
          `;
          if (distMeters < 3000) nearbyClass = 'nearby';
        } else {
          distHtml = `<div class="badges"><span class="badge" style="background:#eee; color:#666;">No GPS Data</span></div>`;
        }

        const card = document.createElement('div');
        card.className = `card ${nearbyClass}`;
        card.innerHTML = `
          <div class="card-header">
            <div class="card-title">${place.name}</div>
            <button class="fav-btn ${isFav?'active':''}" onclick="toggleFav('${place.name}', this)">
              <i class="${isFav?'fas':'far'} fa-star"></i>
            </button>
          </div>
          <div class="card-body">
            ${distHtml}
            <button class="copy-btn" onclick="copyToClip('${place.coords}', this)">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
        `;
        UI.list.appendChild(card);
      });
    }

    function setFilter(type) {
      state.filter = type;
      UI.navHome.classList.toggle('active', type === 'all');
      UI.navFav.classList.toggle('active', type === 'fav');
      render();
    }

    function toggleFav(name, btn) {
      if (state.favs.has(name)) {
        state.favs.delete(name);
        btn.classList.remove('active');
        btn.querySelector('i').className = 'far fa-star';
      } else {
        state.favs.add(name);
        btn.classList.add('active');
        btn.querySelector('i').className = 'fas fa-star';
      }
      localStorage.setItem(CONFIG.STORAGE_KEYS.FAVS, JSON.stringify([...state.favs]));
      if (state.filter === 'fav') render();
    }

    function handleAddPlace(e) {
      e.preventDefault();
      const name = document.getElementById('newPlaceName').value.trim();
      const coords = document.getElementById('newPlaceCoords').value.trim();
      
      if (name && parseCoords(coords)) {
        const newPlace = { name, coords };
        state.userPlaces.push(newPlace);
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER_PLACES, JSON.stringify(state.userPlaces));
        
        closeModal('addModal');
        e.target.reset();
        
        state.allPlaces.push(newPlace);
        showToast('Place added successfully', 'success');
        render();
      }
    }

    // --- FIXED COPY & ANIMATION FUNCTION ---
    function copyToClip(text, btn) {
      // 1. Trigger animation IMMEDIATELY (Visual feedback)
      fireConfetti(btn);

      // 2. Handle Button State
      const original = btn.innerHTML;
      btn.innerHTML = `<i class="fas fa-check"></i> Done!`;
      btn.style.background = 'var(--primary)';
      
      // Reset button after delay
      setTimeout(() => {
        btn.innerHTML = original;
        btn.style.background = '';
      }, 1500);

      // 3. Attempt to copy text (Logic separated from animation)
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).catch(err => {
          console.error('Clipboard API failed, trying fallback', err);
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    // Fallback for non-secure contexts (file://) or older browsers
    function fallbackCopy(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";  // Avoid scrolling to bottom
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if(successful) {
           // Optional: Show a specific toast if needed
           // showToast('Copied via fallback', 'success');
        }
      } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
      }
      
      document.body.removeChild(textArea);
    }

    // --- WINNER ANIMATION LOGIC ---
    function fireConfetti(element) {
      // Ensure element is valid
      if(!element) return;

      // Get accurate button position
      const rect = element.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      const colors = ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d'];
      const particleCount = 40; 

      for (let i = 0; i < particleCount; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti');
        
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        
        const isCircle = Math.random() < 0.5;
        confetti.style.borderRadius = isCircle ? '50%' : '2px';
        
        // Set Start Position (Center of button) - Fixed position for viewport
        confetti.style.left = `${centerX}px`;
        confetti.style.top = `${centerY}px`;
        
        // Physics
        const angle = Math.random() * Math.PI * 2;
        const velocity = 60 + Math.random() * 100; 
        
        const tx = Math.cos(angle) * velocity;
        const ty = Math.sin(angle) * velocity - 50; 
        const rot = Math.random() * 720; 

        confetti.style.setProperty('--tx', `${tx}px`);
        confetti.style.setProperty('--ty', `${ty}px`);
        confetti.style.setProperty('--rot', `${rot}deg`);
        
        const duration = 0.8 + Math.random() * 0.5;
        confetti.style.animation = `confetti-fall ${duration}s cubic-bezier(0.25, 1, 0.5, 1) forwards`;

        document.body.appendChild(confetti);

        // Cleanup
        setTimeout(() => {
          confetti.remove();
        }, duration * 1000);
      }
    }

    function openMap() {
      if (state.userLocation) {
        window.open(`https://www.openstreetmap.org/?mlat=${state.userLocation.lat}&mlon=${state.userLocation.lng}#map=14/${state.userLocation.lat}/${state.userLocation.lng}`, '_blank');
      } else {
        showToast('Enable GPS to see your location', 'info');
        toggleGPS();
      }
    }

    function openModal(id) {
      document.getElementById(id).classList.add('open');
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove('open');
    }
    
    function showToast(msg, type = 'info') {
      UI.toast.querySelector('span').innerText = msg;
      UI.toast.className = `show ${type === 'success' ? 'success' : ''}`;
      UI.toast.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-info-circle';
      
      setTimeout(() => {
        UI.toast.className = '';
      }, 3000);
    }
  </script>
</body>
</html>